<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ’ãƒœãƒ³ã‚²ãƒ¼ãƒ  - éå‡¡ãªäººé–“ã§ã‚ã‚‹åŒºåˆ¥å®Ÿè·µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff9a56 0%, #ffdb4d 50%, #ff6b35 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #d63031;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .week-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .current-week {
            font-size: 1.3em;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 10px;
        }

        .week-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .week-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9a56 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .week-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
        }

        .week-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #ff6b35;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #d63031;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        .section-subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }

        .distinctions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .distinction-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .distinction-card:hover {
            border-color: #ff6b35;
            background: #fff3e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
        }

        .distinction-card.selected {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.1);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.2);
        }

        .distinction-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .distinction-card.selected .distinction-checkbox {
            background: #00b894;
            border-color: #00b894;
            color: white;
        }

        .distinction-name {
            font-weight: bold;
            color: #d63031;
            margin-bottom: 8px;
            font-size: 1.1em;
            padding-right: 40px;
        }

        .distinction-practice {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .bingo-section {
            margin: 30px 0;
        }

        .bingo-title {
            color: #d63031;
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
        }

        .bingo-grid {
            overflow-x: auto;
            padding: 10px 0;
        }

        .bingo-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stage-header {
            text-align: center;
            font-weight: bold;
            color: white;
            padding: 15px 10px;
            font-size: 1.1em;
        }

        .stage-focus {
            background: #90EE90;
        }

        .stage-momentum {
            background: #FFA500;
        }

        .stage-breakthrough {
            background: #FFD700;
        }

        .distinction-row {
            border-bottom: 1px solid #eee;
        }

        .distinction-label {
            padding: 15px;
            font-weight: bold;
            color: #d63031;
            background: #f8f9fa;
            border-right: 2px solid #ddd;
            min-width: 150px;
            font-size: 0.9em;
        }

        .bingo-cell {
            width: 50px;
            height: 50px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: white;
        }

        .bingo-cell.stage-focus {
            background: rgba(144, 238, 144, 0.3);
        }

        .bingo-cell.stage-momentum {
            background: rgba(255, 165, 0, 0.3);
        }

        .bingo-cell.stage-breakthrough {
            background: rgba(255, 215, 0, 0.3);
        }

        .bingo-cell:hover {
            border-color: #ff6b35;
            transform: scale(1.05);
        }

        .bingo-cell.completed {
            background: #00b894 !important;
            border-color: #00b894;
        }

        .bingo-cell.completed::after {
            content: 'â—';
            color: white;
            font-size: 24px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .level-arrow {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .level-arrow::after {
            content: ' â†’';
            font-size: 1.5em;
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }

        .controls {
            text-align: center;
        }

        .controls-title {
            color: #d63031;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(116, 185, 255, 0.4);
        }

        .control-btn.success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }

        .control-btn.danger {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .distinctions-grid {
                grid-template-columns: 1fr;
            }

            .bingo-table {
                min-width: 600px;
            }

            .bingo-cell {
                width: 40px;
                height: 40px;
            }

            .distinction-label {
                font-size: 0.8em;
                min-width: 120px;
            }

            .control-buttons {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ ãƒ’ãƒœãƒ³ã‚²ãƒ¼ãƒ </h1>
            <div class="subtitle">éå‡¡ãªäººé–“ã§ã‚ã‚‹ã¨ã„ã†åŒºåˆ¥ã‚’å®Ÿè·µã™ã‚‹</div>
        </div>

        <div class="week-info">
            <div class="current-week" id="currentWeek">2025å¹´6æœˆ8æ—¥ã€œ6æœˆ14æ—¥</div>
            <div class="week-nav">
                <button class="week-btn" id="prevWeek">â—€ å‰ã®é€±</button>
                <button class="week-btn" id="nextWeek">æ¬¡ã®é€± â–¶</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">ä»Šé€±ã®å®Ÿè·µãƒã‚¹æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stageCount">0</div>
                <div class="stat-label">åˆ°é”æ®µéšæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="selectedCount">0</div>
                <div class="stat-label">é¸æŠä¸­ã®åŒºåˆ¥</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“ ä»Šé€±å®Ÿè·µã™ã‚‹åŒºåˆ¥ã‚’é¸æŠ</h2>
            <p class="section-subtitle">7ã¤ã®åŒºåˆ¥ã‹ã‚‰ä»Šé€±å®Ÿè·µã—ãŸã„ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            
            <div class="distinctions-grid" id="distinctionsGrid">
                <!-- JavaScriptã§ç”Ÿæˆ -->
            </div>

            <div class="bingo-section" id="bingoSection">
                <!-- ãƒ“ãƒ³ã‚´ã‚°ãƒªãƒƒãƒ‰ãŒã“ã“ã«è¡¨ç¤º -->
            </div>
        </div>

        <div class="section">
            <div class="controls">
                <h3 class="controls-title">ğŸ“Š ç®¡ç†æ©Ÿèƒ½</h3>
                <div class="control-buttons">
                    <button class="control-btn success" onclick="completeWeek()">âœ… ä»Šé€±å®Œäº†</button>
                    <button class="control-btn" onclick="showHistory()">ğŸ“š å±¥æ­´è¡¨ç¤º</button>
                    <button class="control-btn" onclick="exportData()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    <button class="control-btn" onclick="importData()">ğŸ“ å¾©å…ƒ</button>
                    <button class="control-btn danger" onclick="resetWeek()">ğŸ”„ ä»Šé€±ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“š å®Ÿè·µå±¥æ­´</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="historyContent">
                <!-- å±¥æ­´å†…å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // åŒºåˆ¥ãƒ‡ãƒ¼ã‚¿
        const DISTINCTIONS = [
            {
                id: 'integrity',
                name: 'INTEGRITY',
                practice: 'è‡ªåˆ†ã®è¨€è‘‰ã‚’å°Šã¶ã€‚ã¤ã¾ã‚Šã€ã‚„ã‚‹ã¨è¨€ã£ãŸã“ã¨ã‚’ã‚„ã‚‹ã€‚è¨€ã£ãŸæ™‚é–“ã¾ã§ã«ã‚„ã‚‹ã€‚ã‚„ã‚‰ãªã„ã¨ãã¯ãã‚Œã‚’æ¸…æƒã™ã‚‹ã€‚æ–°ã—ã„ç´„æŸã‚’ã—ã€ãã‚Œã‚’å®ˆã‚‹ã€‚'
            },
            {
                id: 'freedom',
                name: 'ãƒšãƒ†ãƒ³ã‹ã‚‰è‡ªç”±ã§ã‚ã‚‹',
                practice: 'ã€Œã‚ãŸã—ãŒæ­£ã—ã„ã€ã‚’æ‰‹æ”¾ã™ã€‚'
            },
            {
                id: 'powerful',
                name: 'ãƒ‘ãƒ¯ãƒ•ãƒ«ã§ã‚ã‚‹',
                practice: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã§ã‚ã‚Šã€å¾—ãŸã‚‚ã®ã‚’å–ã‚‹ã€‚'
            },
            {
                id: 'brave',
                name: 'å‹‡æ•¢ã§ã‚ã‚‹',
                practice: 'æã‚Œã‚’æ‰¿èªã—ã€ãã—ã¦è¡Œå‹•ã™ã‚‹ã€‚'
            },
            {
                id: 'peaceful',
                name: 'å¹³å’Œã§ç©ã‚„ã‹ã§ã‚ã‚‹',
                practice: 'ã€Œã“ã“ã«ã¯ä½•ã‹æ‚ªã„ã“ã¨ãŒã‚ã‚‹ã€ã¨ã„ã†è‡ªåˆ†ã®è§£é‡ˆã‚’æ‰‹æ”¾ã™ã€‚'
            },
            {
                id: 'charisma',
                name: 'ã‚«ãƒªã‚¹ãƒãŒã‚ã‚‹',
                practice: 'ã€Œã€œã™ã‚‹ãŸã‚ã«ã€ã¨ã‹ã©ã“ã‹ã«è¡Œãç€ã“ã†ã¨ã™ã‚‹ã“ã¨ã‚’æ‰‹æ”¾ã™ã€‚'
            },
            {
                id: 'enrolling',
                name: 'ã‚¨ãƒ³ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã§ã‚ã‚‹',
                practice: 'è‡ªåˆ†ã®æ–°ã—ã„å¯èƒ½æ€§ã‚’ã€ä»–ã®äººãŒãã®å¯èƒ½æ€§ã«å¿ƒã‚’è§¦ã‚Œã‚‰ã‚Œæ„Ÿå‹•ã—ã‚¤ãƒ³ã‚¹ãƒ‘ã‚¤ã‚¢ã™ã‚‹ã‚ˆã†ã«åˆ†ã‹ã¡åˆã†ã€‚'
            }
        ];

        // ã‚²ãƒ¼ãƒ è¨­å®š
        const GAME_START = new Date('2025-06-08');
        const GAME_END = new Date('2025-09-10');

        // ç¾åœ¨ã®çŠ¶æ…‹
        let currentWeekStart = getWeekStart(new Date('2025-06-08'));
        let gameData = loadData();

        // é€±ã®é–‹å§‹æ—¥ã‚’å–å¾—ï¼ˆæ—¥æ›œæ—¥é–‹å§‹ï¼‰
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆlocalStorageå¯¾å¿œï¼‰
        function loadData() {
            try {
                const savedData = localStorage.getItem('hibonGameData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    console.log('Data loaded from localStorage');
                    return parsed;
                }
                
                console.log('No saved data found, creating new data');
                return {
                    weeks: {},
                    history: []
                };
            } catch (e) {
                console.warn('localStorage not available, using memory storage:', e);
                
                if (!window.hibonGameData) {
                    window.hibonGameData = {
                        weeks: {},
                        history: []
                    };
                }
                return window.hibonGameData;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆlocalStorageå¯¾å¿œï¼‰
        function saveData() {
            try {
                localStorage.setItem('hibonGameData', JSON.stringify(gameData));
                console.log('Data saved to localStorage');
            } catch (e) {
                console.warn('localStorage save failed, using memory storage:', e);
                window.hibonGameData = gameData;
                console.log('Data saved to memory');
            }
        }

        // é€±ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        function getWeekData() {
            const weekKey = currentWeekStart.toISOString().split('T')[0];
            if (!gameData.weeks[weekKey]) {
                gameData.weeks[weekKey] = {
                    selected: [],
                    progress: {}
                };
            }
            return gameData.weeks[weekKey];
        }

        // åŒºåˆ¥é¸æŠã®æç”»
        function renderDistinctions() {
            const grid = document.getElementById('distinctionsGrid');
            const weekData = getWeekData();
            
            grid.innerHTML = '';
            
            DISTINCTIONS.forEach(distinction => {
                const isSelected = weekData.selected.includes(distinction.id);
                
                const card = document.createElement('div');
                card.className = `distinction-card ${isSelected ? 'selected' : ''}`;
                card.onclick = () => toggleDistinction(distinction.id);
                
                card.innerHTML = `
                    <div class="distinction-checkbox">${isSelected ? 'âœ“' : ''}</div>
                    <div class="distinction-name">${distinction.name}</div>
                    <div class="distinction-practice">${distinction.practice}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        // ãƒ“ãƒ³ã‚´ã‚°ãƒªãƒƒãƒ‰ã®æç”»
        function renderBingoGrid() {
            const section = document.getElementById('bingoSection');
            const weekData = getWeekData();
            
            if (weekData.selected.length === 0) {
                section.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“ åŒºåˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                        <p>ä¸Šè¨˜ã‹ã‚‰å®Ÿè·µã—ãŸã„åŒºåˆ¥ã‚’é¸ã‚“ã§ã€ãƒ“ãƒ³ã‚´ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
                    </div>
                `;
                return;
            }
            
            section.innerHTML = `
                <div class="bingo-title">ğŸ¯ éå‡¡è£…ç€ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ï¼</div>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    ã‚ãªãŸãŒéå‡¡ã§ã‚ã‚‹ã¨ãã€äººç”Ÿã¯æ–°ãŸãªãƒ¬ãƒ™ãƒ«ã®èˆˆå¥®ã¨å¯èƒ½æ€§ã‚’ã¾ã¨ã„å§‹ã‚ã¦ã„ã‚‹ï¼ï¼
                </p>
                <div class="bingo-grid">
                    <table class="bingo-table">
                        <thead>
                            <tr>
                                <th style="background: #f8f9fa; border: 1px solid #ddd;"></th>
                                <th colspan="3" class="stage-header stage-focus">é›†ä¸­æœŸ</th>
                                <th colspan="3" class="stage-header stage-momentum">ã¯ãšã¿æœŸ</th>
                                <th colspan="4" class="stage-header stage-breakthrough">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¹ãƒ«ãƒ¼ZONE</th>
                            </tr>
                        </thead>
                        <tbody id="bingoTableBody">
                            <!-- JavaScriptã§ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <div class="level-arrow">è»½ã•ãƒ»è‡ªç”±ã•ãƒ¬ãƒ™ãƒ«</div>
            `;
            
            const tbody = document.getElementById('bingoTableBody');
            
            weekData.selected.forEach(distId => {
                const distinction = DISTINCTIONS.find(d => d.id === distId);
                if (!distinction) return;
                
                if (!weekData.progress[distId]) {
                    weekData.progress[distId] = new Array(10).fill(false);
                }
                
                const row = document.createElement('tr');
                row.className = 'distinction-row';
                
                let html = `<td class="distinction-label">${distinction.name}</td>`;
                
                for (let i = 0; i < 10; i++) {
                    let stageClass = '';
                    if (i < 3) stageClass = 'stage-focus';
                    else if (i < 6) stageClass = 'stage-momentum';
                    else stageClass = 'stage-breakthrough';
                    
                    const isCompleted = weekData.progress[distId][i];
                    const canClick = canToggleCell(distId, i);
                    
                    html += `
                        <td class="bingo-cell ${stageClass} ${isCompleted ? 'completed' : ''}" 
                            onclick="${canClick ? `toggleCell('${distId}', ${i})` : ''}"
                            style="${!canClick ? 'cursor: not-allowed; opacity: 0.5;' : ''}">
                        </td>
                    `;
                }
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        // ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canToggleCell(distId, index) {
            const weekData = getWeekData();
            const progress = weekData.progress[distId];
            
            const lastCompletedIndex = progress.lastIndexOf(true);
            
            if (lastCompletedIndex === -1) {
                return index === 0;
            } else {
                return index <= lastCompletedIndex + 1;
            }
        }

        // ã‚»ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleCell(distId, index) {
            const weekData = getWeekData();
            const progress = weekData.progress[distId];
            
            if (!canToggleCell(distId, index)) return;
            
            const isCompleted = progress[index];
            
            if (!isCompleted) {
                progress[index] = true;
            } else {
                const lastCompletedIndex = progress.lastIndexOf(true);
                if (index === lastCompletedIndex) {
                    progress[index] = false;
                }
            }
            
            saveData();
            renderBingoGrid();
            updateStats();
        }

        // åŒºåˆ¥ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
        function toggleDistinction(distId) {
            const weekData = getWeekData();
            const index = weekData.selected.indexOf(distId);
            
            if (index === -1) {
                weekData.selected.push(distId);
                weekData.progress[distId] = new Array(10).fill(false);
            } else {
                weekData.selected.splice(index, 1);
                delete weekData.progress[distId];
            }
            
            saveData();
            renderDistinctions();
            renderBingoGrid();
            updateStats();
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const weekData = getWeekData();
            let totalCount = 0;
            let stageCount = 0;
            
            weekData.selected.forEach(distId => {
                if (weekData.progress[distId]) {
                    const completed = weekData.progress[distId].filter(Boolean).length;
                    totalCount += completed;
                    
                    if (completed >= 10) stageCount += 3;
                    else if (completed >= 6) stageCount += 2;
                    else if (completed >= 3) stageCount += 1;
                }
            });
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('stageCount').textContent = stageCount;
            document.getElementById('selectedCount').textContent = weekData.selected.length;
        }

        // é€±è¡¨ç¤ºæ›´æ–°
        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            const startStr = `${currentWeekStart.getFullYear()}å¹´${currentWeekStart.getMonth() + 1}æœˆ${currentWeekStart.getDate()}æ—¥`;
            const endStr = `${weekEnd.getMonth() + 1}æœˆ${weekEnd.getDate()}æ—¥`;
            
            document.getElementById('currentWeek').textContent = `${startStr}ã€œ${endStr}`;
            
            const prevWeek = new Date(currentWeekStart);
            prevWeek.setDate(currentWeekStart.getDate() - 7);
            document.getElementById('prevWeek').disabled = prevWeek < GAME_START;
            
            const nextWeek = new Date(currentWeekStart);
            nextWeek.setDate(currentWeekStart.getDate() + 7);
            document.getElementById('nextWeek').disabled = nextWeek > GAME_END;
        }

        // é€±ç§»å‹•
        function changeWeek(direction) {
            const newWeek = new Date(currentWeekStart);
            newWeek.setDate(currentWeekStart.getDate() + (direction * 7));
            
            if (newWeek >= GAME_START && newWeek <= GAME_END) {
                currentWeekStart = newWeek;
                renderDistinctions();
                renderBingoGrid();
                updateWeekDisplay();
                updateStats();
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
        function backupData() {
            try {
                const dataStr = JSON.stringify(gameData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `hibon_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼');
            } catch (e) {
                console.error('Backup failed:', e);
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // å¾©å…ƒæ©Ÿèƒ½
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.weeks && importedData.history) {
                            if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                                gameData = importedData;
                                saveData();
                                
                                renderDistinctions();
                                renderBingoGrid();
                                updateStats();
                                
                                alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
                            }
                        } else {
                            alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚');
                        }
                    } catch (e) {
                        console.error('Restore failed:', e);
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ä»Šé€±å®Œäº†
        function completeWeek() {
            if (confirm('ä»Šé€±ã‚’å®Œäº†ã—ã¦å±¥æ­´ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
                const weekData = getWeekData();
                const weekKey = currentWeekStart.toISOString().split('T')[0];
                
                gameData.history.push({
                    week: weekKey,
                    data: JSON.parse(JSON.stringify(weekData)),
                    completed: new Date().toISOString()
                });
                
                delete gameData.weeks[weekKey];
                saveData();
                
                renderDistinctions();
                renderBingoGrid();
                updateStats();
                
                alert('ä»Šé€±ã®è¨˜éŒ²ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
        }

        // å±¥æ­´è¡¨ç¤º
        function showHistory() {
            const content = document.getElementById('historyContent');
            
            if (gameData.history.length === 0) {
                content.innerHTML = '<p>ã¾ã å®Œäº†ã—ãŸé€±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                let html = '';
                gameData.history.forEach(entry => {
                    const date = new Date(entry.week);
                    let totalCount = 0;
                    let stageCount = 0;
                    
                    entry.data.selected.forEach(distId => {
                        if (entry.data.progress[distId]) {
                            const completed = entry.data.progress[distId].filter(Boolean).length;
                            totalCount += completed;
                            
                            if (completed >= 10) stageCount += 3;
                            else if (completed >= 6) stageCount += 2;
                            else if (completed >= 3) stageCount += 1;
                        }
                    });
                    
                    html += `
                        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                            <h4>${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ã®é€±</h4>
                            <p>å®Ÿè·µãƒã‚¹æ•°: ${totalCount}å€‹</p>
                            <p>åˆ°é”æ®µéšæ•°: ${stageCount}æ®µéš</p>
                            <p>é¸æŠã—ãŸåŒºåˆ¥: ${entry.data.selected.length}å€‹</p>
                        </div>
                    `;
                });
                content.innerHTML = html;
            }
            
            document.getElementById('historyModal').style.display = 'block';
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            backupData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            restoreData();
        }

        // ä»Šé€±ãƒªã‚»ãƒƒãƒˆ
        function resetWeek() {
            if (confirm('ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                const weekKey = currentWeekStart.toISOString().split('T')[0];
                delete gameData.weeks[weekKey];
                saveData();
                
                renderDistinctions();
                renderBingoGrid();
                updateStats();
                
                alert('ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
        function autoBackup() {
            try {
                if (Object.keys(gameData.weeks).length > 0 || gameData.history.length > 0) {
                    saveData();
                    console.log('Auto backup completed');
                }
            } catch (e) {
                console.warn('Auto backup failed:', e);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        function validateData(data) {
            if (!data || typeof data !== 'object') return false;
            if (!data.weeks || typeof data.weeks !== 'object') return false;
            if (!Array.isArray(data.history)) return false;
            
            for (const weekKey in data.weeks) {
                const week = data.weeks[weekKey];
                if (!Array.isArray(week.selected)) return false;
                if (!week.progress || typeof week.progress !== 'object') return false;
            }
            
            return true;
        }

        // åˆæœŸåŒ–
        function init() {
            console.log('ãƒ’ãƒœãƒ³ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');
            
            if (!validateData(gameData)) {
                console.warn('Invalid data detected, resetting to default');
                gameData = {
                    weeks: {},
                    history: []
                };
                saveData();
            }
            
            setInterval(autoBackup, 5 * 60 * 1000);
            
            document.getElementById('prevWeek').addEventListener('click', () => changeWeek(-1));
            document.getElementById('nextWeek').addEventListener('click', () => changeWeek(1));
            
            window.addEventListener('beforeunload', () => {
                saveData();
            });
            
            document.getElementById('historyModal').addEventListener('click', (e) => {
                if (e.target.id === 'historyModal') {
                    closeModal();
                }
            });
            
            renderDistinctions();
            renderBingoGrid();
            updateWeekDisplay();
            updateStats();
            
            console.log('ãƒ’ãƒœãƒ³ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
